{# Base elements #}

{% macro listButtons(buttons) %}{% spaceless %}
    <ul class="wh-list-buttons">
        {% for button in buttons %}

            {% set button = button | merge({'class' : 'btn'}) %}
            {% if button.class is defined %}
                {% set button = button | merge({'class' : button.class}) %}
            {% else %}
                {% set button = button | merge({'class' : ''}) %}
            {% endif %}
            {% if button.size is defined %}
                {% set button = button | merge({'class' : button.class ~ ' btn-' ~ button.size}) %}
            {% endif %}
            {% if button.color is defined %}
                {% set button = button | merge({'class' : button.class ~ ' btn-' ~ button.color}) %}
            {% else %}
                {% set button = button | merge({'class' : button.class ~ ' btn-primary'}) %}
            {% endif %}
            {% if button.type is not defined %}
                {% set button = button | merge({'type' : 'submit'}) %}
            {% endif %}
            {% if button.icon is defined %}
                {% set label = '<i class="fa fa-' ~ button.icon ~ '"></i>' %}
                {% if button.label is defined %}
                    {% set label = label ~ ' ' ~ button.label %}
                {% endif %}
                {% set button = button | merge({'label' : label}) %}
            {% endif %}

            <li>
                {% if button.buttonType == 'link' %}

                    <a {% if button.href is defined %}href="{{ button.href }}"{% endif %}
                       class="{{ button.class }}" {% if button.modal is defined %}data-modal="modalAjax"{% endif %} {% if button.target is defined %}target="{{ button.target }}"{% endif %} {% if button.confirm is defined %}onclick="return confirm('{{ button.confirm }}')"{% endif %} >{{ button.label | raw }}</a>

                {% elseif button.buttonType == 'button' %}

                    <button type="{{ button.type }}" class="{{ button.class }}">{{ button.label | raw }}</button>

                {% endif %}
            </li>

        {% endfor %}
    </ul>
{% endspaceless %}{% endmacro %}

{% macro listFormButtons(buttons, form) %}{% spaceless %}
    <ul class="wh-list-buttons">
        {% for button in buttons %}

            {% set button = button | merge({'class' : 'btn'}) %}
            {% if button.class is defined %}
                {% set button = button | merge({'class' : button.class}) %}
            {% else %}
                {% set button = button | merge({'class' : ''}) %}
            {% endif %}
            {% if button.size is defined %}
                {% set button = button | merge({'class' : button.class ~ ' btn-' ~ button.size}) %}
            {% endif %}
            {% if button.color is defined %}
                {% set button = button | merge({'class' : button.class ~ ' btn-' ~ button.color}) %}
            {% else %}
                {% set button = button | merge({'class' : button.class ~ ' btn-primary'}) %}
            {% endif %}
            {% if button.icon is defined %}
                {% set label = '<i class="fa fa-' ~ button.icon ~ '"></i>' %}
                {% if button.label is defined %}
                    {% set label = label ~ ' ' ~ button.label %}
                {% endif %}
                {% set button = button | merge({'label' : label}) %}
            {% endif %}

            <li>
                {{ form_widget(attribute(form, button.field), {'label' : button.label, 'attr' : {'class' : button.class, 'data-submit-name' : button.field}}) }}
            </li>

        {% endfor %}
    </ul>
{% endspaceless %}{% endmacro %}

{% macro formFields(form, formFields) %}{% spaceless %}

    {% set col = 0 %}

    {% for formField, properties  in formFields %}

        {% if properties.type is defined and properties.type == 'wh_file' %}

            <div class="row">
                <div class="col-md-12">
                    {% set attribute = attribute(attribute(form, formField), 'url') %}
                    {% set data = attribute(form.vars.data, formField) %}
                    {% if data is not empty %}
                        <div class="form-group">
                            <div class="control-label">
                                {% if data.isImage %}
                                    <a href="{{ wh_media_baseurl ~ attribute(data, 'url') }}" target="_blank">
                                        <img src="{{ wh_media_baseurl ~ attribute(data, 'url') }}"
                                             class="img-responsive">
                                    </a>
                                {% else %}
                                    <a href="{{ attribute(data, 'url') }}" class="btn btn-primary btn-xs"
                                       target="_blank">
                                        <i class="fa fa-eye"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {{ form_row(attribute) }}
                    {{ form_row(attribute(attribute(form, formField), 'alt')) }}
                </div>
            </div>

        {% else %}

            {% if properties.col is not defined %}
                {% set properties = properties | merge({'col' : 12}) %}
            {% endif %}

            {% set col = col + properties.col %}

            {% if loop.first or col > 12 %}

                {% if not loop.first %}
                    </div>
                    {% set col = properties.col %}
                {% endif %}

                <div class="row">

            {% endif %}

            <div class="{{ 'col-md-' ~ properties.col }}">

                {% set formFieldFields = formField | split('.') %}
                {% set formFieldValue = '' %}

                {% for formFieldField in formFieldFields %}

                    {% if loop.first %}
                        {% set formFieldValue = attribute(form, formFieldField) %}
                    {% else %}
                        {% set formFieldValue = attribute(formFieldValue, formFieldField) %}
                    {% endif %}

                {% endfor %}

                {{ form_row(formFieldValue) }}
            </div>

            {% if loop.last %}
                </div>
            {% endif %}

        {% endif %}

    {% endfor %}

{% endspaceless %}{% endmacro %}

{% macro formZone(form, formZone) %}{% spaceless %}

    {% if formZone.title is defined %}
        <legend>{{ formZone.title }}</legend>
    {% endif %}

    {% if formZone.fields is defined %}
        {{ _self.formFields(form, formZone.fields) }}
    {% endif %}

{% endspaceless %}{% endmacro %}

{% macro panel(properties) %}{% spaceless %}

    {% if properties.color is not defined %}
        {% set properties = properties | merge({'color' : 'default'}) %}
    {% endif %}

    <div class="ibox {{ 'panel-' ~ properties.color }}">

        <div class="ibox-title">

            <table>
                <tr>
                    <td>
                        <span>{% if properties.icon is defined %}<i
                                class="{{ 'fa fa-' ~ properties.icon }}"></i> {% endif %}{{ properties.headerLabel }}</span>
                    </td>
                    {% if properties.headerListButtons is defined %}
                        <td class="right">
                            {{ _self.listButtons(properties.headerListButtons) }}
                        </td>
                    {% endif %}
                </tr>
            </table>

        </div>

        <div class="ibox-content">
            {% if properties.formFields is defined %}
                {{ _self.formFields(properties.form, properties.formFields) }}
            {% endif %}
            {% if properties.tableFields is defined %}
                {% if properties.sortable is defined %}
                    <div class="wh-sortable">
                        {{ _self.table(properties.tableFields, properties.entities, {'sortable': true}) }}
                    </div>
                {% else %}
                    {{ _self.table(properties.tableFields, properties.entities, {}) }}
                {% endif %}
            {% endif %}

            {% if properties.footerListButtons is defined %}
                <div>
                    {{ _self.listButtons(properties.footerListButtons) }}
                </div>
            {% endif %}

            {% if properties.footerListFormButtons is defined %}
                <div>
                    {{ _self.listFormButtons(properties.footerListFormButtons, properties.form) }}
                </div>
            {% endif %}

        </div>

    </div>

{% endspaceless %}{% endmacro %}

{% macro getValueOfEntity(entity, wantedValueSlug) %}{% spaceless %}

    {% set fields = wantedValueSlug | split('.') %}
    {% set value = '' %}

    {% for field in fields %}

        {% if loop.first %}
            {% set value = attribute(entity, field) %}
        {% else %}
            {% if value %}
                {% set value = attribute(value, field) %}
            {% endif %}
        {% endif %}

    {% endfor %}

    {{ value }}

{% endspaceless %}{% endmacro %}

{% macro table(fields, entities, properties) %}{% spaceless %}

    <table class="wh-table table table-striped">

        <thead>
        <tr>
            {% for name in fields %}
                <th>{% if name.label is defined %}{{ name.label }}{% endif %}</th>
            {% endfor %}
        </tr>
        </thead>

        {% for entity in entities %}

            {% set trClass = '' %}

            {% if attribute(entity, 'status') is defined %}
                {% if attribute(entity, 'status') == 0 %}
                    {% set trClass = 'danger' %}
                {% else %}
                    {% set trClass = 'success' %}
                {% endif %}
            {% endif %}

            <tr class="{{ trClass }}" {% if properties.sortable is defined %}data-id="{{ entity.id }}"{% endif %}>
                {% for property, value in fields %}

                    {% if value.multipleFields is defined %}

                        {% set entityButtons = [] %}

                        {% for key, entityButton in value %}

                            {% if key != 'multipleFields' %}

                                {% set entityButton = entityButton | merge({'buttonType' : 'link'}) %}
                                {% set entityButton = entityButton | merge({'size' : 'xs'}) %}

                                {% if entityButton.parameters is defined %}

                                    {% set entityRouteParams = [] %}

                                    {% for routeParamName, routeParam in entityButton.parameters %}

                                        {% set routeParamFields = routeParam | split('.') %}
                                        {% set routeParamValue = '' %}

                                        {% for routeParamField in routeParamFields %}

                                            {% if loop.first %}
                                                {% set routeParamValue = attribute(entity, routeParamField) %}
                                            {% else %}
                                                {% set routeParamValue = attribute(routeParamValue, routeParamField) %}
                                            {% endif %}

                                        {% endfor %}

                                        {% set entityRouteParam = routeParamValue %}

                                        {% set entityRouteParams = entityRouteParams | merge({(routeParamName) : entityRouteParam}) %}

                                    {% endfor %}

                                    {% set entityButton = entityButton | merge({'href' : path(entityButton.route, entityRouteParams)}) %}

                                {% endif %}

                                {% set entityButtons = entityButtons | merge([entityButton]) %}

                            {% endif %}

                        {% endfor %}

                        <td>{{ _self.listButtons(entityButtons) }}</td>

                    {% else %}

                        {% if value.type is defined and value.type == 'link' %}
                            {% set entityValue = _self.getValueOfEntity(entity, property) %}
                            {% if not (entityValue matches '#http://.*#') %}
                                {% set entityValue = path('ft_wh_seo_router_dispatch', {'url' : entityValue}) %}
                            {% endif %}
                            <td>
                                <a href="{{ entityValue }}" target="_blank">
                                    {{ _self.getValueOfEntity(entity, property) }}
                                </a>
                            </td>
                        {% else %}

                            {% if value.type is defined and value.type == 'boolean' %}
                                <td>{% if _self.getValueOfEntity(entity, property) %}Oui{% else %}Non{% endif %}</td>
                            {% else %}
                                <td>{{ _self.getValueOfEntity(entity, property) }}</td>
                            {% endif %}

                        {% endif %}

                    {% endif %}

                {% endfor %}
            </tr>
        {% endfor %}

    </table>

{% endspaceless %}{% endmacro %}
